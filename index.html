<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>é˜¿è¨˜ä¸‰ç¼ºä¸€</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="é˜¿è¨˜å¨›æ¨‚åŸ">

  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root {
      --gold: #ffd86b;
      --dark-red: #4a0404;
      --card-bg: rgba(255, 255, 255, 0.1);
      --red: #ff4757;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at center, #2a0202, #050000);
      color: #fff;
      font-family: "Microsoft JhengHei", Arial;
      height: 100dvh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
#welcomeUserContainer.rank-item {
    display: inline-block;
    padding: 5px 15px;
    margin-top: 5px;
    border-radius: 20px;
}
    /* é€šç”¨é …ç›®æ¨£å¼ */
    .rank-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s;
    }

    /* --- ç¬¬ä¸€åï¼šå‘¼å¸ç‡ˆ + é‡‘å±¬æµå…‰ç‰¹æ•ˆ --- */
    .rank-top1 {
      background: linear-gradient(110deg, #2a2200 20%, #6b5500 50%, #2a2200 80%);
      background-size: 200% auto;
      border: 1px solid #ffd700 !important;
      animation:
        shine-gold 3s linear infinite,
        breathing-glow 2s ease-in-out infinite;
      /* å‘¼å¸ç‡ˆé—œéµ */
      transform: scale(1.02);
      /* ç¨å¾®æ”¾å¤§é¡¯ç¤ºå°Šæ¦®æ„Ÿ */
    }

    .rank-top1 .rank-name {
      color: #fff;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
    }

    .rank-top1 .rank-num {
      font-size: 1.4rem;
    }

    .buy-btn {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 5px 15px;
      border-radius: 5px;
      font-weight: bold;
    }

    .equip-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 5px 15px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    /* å‘¼å¸ç‡ˆå‹•ç•«ï¼šé™°å½±èˆ‡äº®åº¦çš„å¼·å¼±è®ŠåŒ– */
    @keyframes breathing-glow {
      0% {
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        filter: brightness(1);
      }

      50% {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        filter: brightness(1.3);
        /* è®Šäº® */
      }

      100% {
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        filter: brightness(1);
      }
    }

    /* è£å‚™æŒ‰éˆ•æ¨£å¼ */
    .equip-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
    }

    .buy-btn {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
    }

    /* ç‰¹æ•ˆ 1ï¼šç„ç«ç„šèº« (ç´…è‰²ç™¼å…‰) */
    .fx-fire {
      border: 1px solid #ff4757 !important;
      box-shadow: 0 0 10px rgba(255, 71, 87, 0.5), inset 0 0 5px rgba(255, 71, 87, 0.3);
      background: linear-gradient(90deg, rgba(74, 4, 4, 1) 0%, rgba(139, 0, 0, 1) 100%) !important;
    }

    /* ç‰¹æ•ˆ 2ï¼šéœ“è™¹æ¥µå…‰ (è‰²å½©æµå‹•) */
    .fx-neon {
      border: 1px solid #00d2ff !important;
      animation: neonMove 3s linear infinite;
    }

    @keyframes neonMove {
      0% {
        border-color: #00d2ff;
        box-shadow: 0 0 5px #00d2ff;
      }

      33% {
        border-color: #9d50bb;
        box-shadow: 0 0 5px #9d50bb;
      }

      66% {
        border-color: #3a7bd5;
        box-shadow: 0 0 5px #3a7bd5;
      }

      100% {
        border-color: #00d2ff;
        box-shadow: 0 0 5px #00d2ff;
      }
    }

    /* ç‰¹æ•ˆ 3ï¼šé»ƒé‡‘å‘¼å¸ (åŸæœ¬çš„ç¬¬ä¸€åç‰¹æ•ˆï¼Œç¾åœ¨å¤§å®¶éƒ½èƒ½è²·) */
    .fx-gold {
      border: 1px solid #ffd700 !important;
      animation: breathing-glow 2s ease-in-out infinite;
    }

    /* é‡‘å±¬å…‰æ¾¤æµå‹•å‹•ç•« */
    @keyframes shine-gold {
      to {
        background-position: 200% center;
      }
    }

    /* ç¬¬äºŒã€ä¸‰åç°¡å–®æ¼¸å±¤é‚Šæ¡† */
    .rank-top2 {
      border-left: 4px solid #c0c0c0;
      background: rgba(192, 192, 192, 0.1);
    }

    .rank-top3 {
      border-left: 4px solid #cd7f32;
      background: rgba(205, 127, 50, 0.1);
    }

    .rank-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .rank-num {
      min-width: 25px;
      text-align: center;
      font-weight: bold;
    }

    .rank-bal {
      color: #f1c40f;
      font-weight: bold;
    }

    .header {
      height: 50px;
      flex-shrink: 0;
      background: linear-gradient(to bottom, #5c0a0a, #2a0202);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      border-bottom: 2px solid var(--gold);
      z-index: 100;
    }

    .logo {
      font-size: 18px;
      font-weight: 900;
      color: var(--gold);
    }

    .balance-display {
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid var(--gold);
      font-size: 15px;
      color: var(--gold);
      font-weight: bold;
      cursor: pointer;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      overflow: hidden;
    }

    .welcome-msg {
      font-size: 14px;
      color: #ccc;
      text-align: center;
      margin-bottom: 8px;
    }

    .game-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      align-content: start;
      overflow-y: auto;
      padding-bottom: 10px;
    }

    .game-card {
      background: var(--card-bg);
      border: 1px solid #444;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      text-decoration: none;
      color: inherit;
      min-height: 85px;
      transition: transform 0.1s;
    }

    .game-img {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .game-info {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 0 0 12px 12px;
    }

    .game-title {
      font-size: 12px;
      color: var(--gold);
      font-weight: bold;
    }

    .deposit-area {
      width: 100%;
      display: flex;
      gap: 10px;
      flex-shrink: 0;
      padding: 10px 0;
    }

    .btn-deposit {
      flex: 2;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid var(--gold);
      background: linear-gradient(#ff4757, #b91c1c);
      color: #fff;
      font-size: 18px;
      font-weight: 900;
    }

    .btn-rank {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid var(--gold);
      background: linear-gradient(#f59e0b, #92400e);
      color: #fff;
      font-size: 15px;
      font-weight: 900;
    }

    .footer {
      text-align: center;
      padding: 5px 0;
      font-size: 10px;
      color: #444;
    }

    /* --- æ’è¡Œæ¦œå´é‚Šæ¬„ä¿®æ­£ --- */
    #rankOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 2999;
    }

    #rankSidebar {
      position: fixed;
      top: 0;
      right: -100%;
      /* åˆå§‹éš±è—åœ¨å³å´ */
      width: 80%;
      max-width: 320px;
      height: 100%;
      background: #1a0202;
      border-left: 2px solid var(--gold);
      z-index: 3000;
      transition: 0.3s ease;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    #rankSidebar.active {
      right: 0;
    }

    /* å•Ÿå‹•æ™‚æ‹‰å›è¢å¹• */

    .rank-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--gold);
      padding-bottom: 10px;
    }

    .rank-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 5px;
      border-bottom: 1px solid rgba(255, 216, 107, 0.1);
      font-size: 14px;
    }

    .rank-num {
      color: var(--gold);
      font-weight: bold;
      width: 25px;
    }

    .rank-name {
      flex: 1;
      margin-left: 5px;
    }

    .rank-bal {
      color: #fff;
    }

    .close-rank {
      font-size: 30px;
      color: var(--gold);
      cursor: pointer;
    }

    /* æ©«å‘æ¨¡å¼èª¿æ•´ */
    @media (orientation: landscape) {
      .game-grid {
        grid-template-columns: repeat(5, 1fr);
      }

      .game-card {
        min-height: 65px;
      }

      .game-img {
        font-size: 22px;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #1a1a1a;
      border: 2px solid var(--gold);
      padding: 20px;
      border-radius: 20px;
      width: 85%;
      max-width: 320px;
      text-align: center;
    }

    .modal-btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
    }
  </style>
</head>

<body>

  <div class="header">
    <div class="logo">é˜¿è¨˜ä¸‰ç¼ºä¸€</div>
    <div style="color:var(--gold); font-size:13px; cursor:pointer; text-decoration:underline;" onclick="openShop()">ğŸªå•†åŸ
    </div>
    <div class="balance-display" onclick="toggleRank()">ğŸ’ <span id="mainBalance">0</span></div>
  </div>
  <div>
    <marquee style="flex:1; color:var(--gold);">ç·šä¸Šæ¸¬è©¦ç‰ˆ</marquee>
  </div>

  <div class="container">
    <div class="welcome-msg" id="welcomeUser">åç¨±</div>

<div class="welcome-msg">
    <span id="welcomeUserContainer">é¸æ“‡éŠæˆ²</span>
</div>

    <div class="game-grid">
      <a href="sicbo.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #0a5c32, #084325);">ğŸ²</div>
        <div class="game-info">
          <div class="game-title">éª°å¯¶</div>
        </div>
      </a>

      <a href="slot.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #4a0404, #2a0202);">ğŸ°</div>
        <div class="game-info">
          <div class="game-title">777æ‹‰éœ¸æ©Ÿ</div>
        </div>
      </a>
      <a href="horse.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #1e3a8a, #1e1b4b);">ğŸ</div>
        <div class="game-info">
          <div class="game-title">è³½é¦¬å ´</div>
        </div>
      </a>
      <a href="gemslot.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #5b8a1e, #d1f51e);">ğŸ’</div>
        <div class="game-info">
          <div class="game-title">å¯¶çŸ³ç¤¦å‘</div>
        </div>
      </a>
      <a href="link.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #0f3fc4, #12e7f6);">ğŸ²</div>
        <div class="game-info">
          <div class="game-title">æ¶ˆæ¶ˆæ¨‚</div>
        </div>
      </a>
      <a href="mahj.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #e833a2, #d26019);">ğŸ€„</div>
        <div class="game-info">
          <div class="game-title">éº»å°‡æ¶ˆæ¶ˆæ¨‚</div>
        </div>
      </a>
      <a href="heart.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #fcb1df, #f5ac7f);">â¤ï¸</div>
        <div class="game-info">
          <div class="game-title">æ„›å¿ƒ</div>
        </div>
      </a>
      <a href="foodlink.html" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #f1c1c1, #56f19e);">ğŸ°</div>
        <div class="game-info">
          <div class="game-title">é€£é€£çœ‹</div>
        </div>
      </a>
      <a href="#" class="game-card">
        <div class="game-img" style="background: linear-gradient(45deg, #312222, #bad7c7);">ğŸ§§</div>
        <div class="game-info">
          <div class="game-title">(æš«ç„¡)æœªå®Œæˆåˆ®åˆ®æ¨‚</div>
        </div>
      </a>
    </div>

    <div class="deposit-area">
      <button class="btn-deposit" onclick="openModal()">ğŸ’¸ è¬€å‰é˜¿</button>
      <button class="btn-rank" onclick="toggleRank()">ğŸ† æ’è¡Œ</button>
    </div>
  </div>

  <div class="footer">
    &copy; é˜¿è¨˜å¨›æ¨‚åŸ
  </div>

  <div id="rankOverlay" onclick="toggleRank()"></div>
  <div id="rankSidebar">
    <div class="rank-header">
      <h2 style="color:var(--gold); margin:0;">ğŸ’æ’è¡Œæ¦œ</h2>
      <span class="close-rank" onclick="toggleRank()">&times;</span>
    </div>
    <div class="rank-list" id="rankList">
      <p style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</p>
    </div>
  </div>

  <div id="depositModal" class="modal">
    <div class="modal-content">
      <h2 style="color:var(--gold); margin-bottom:15px; font-size: 22px;">åˆ·é˜¿è¨˜çš„å¡</h2>
      <button class="modal-btn" style="background:#3b82f6;" onclick="handleDeposit(10000)">å„²å€¼ 10,000</button>
      <button class="modal-btn" style="background:#a855f7;" onclick="handleDeposit(50000)">å„²å€¼ 50,000</button>
      <button class="modal-btn" style="background:#f59e0b;" onclick="handleDeposit(100000)">å„²å€¼ 100,000</button>
      <button class="modal-btn" style="background:#444; color:#ccc;" onclick="closeModal()">ç®—äº†</button>
    </div>
  </div>
  <div id="shopModal" class="modal">
    <div class="modal-content" style="max-width: 380px; padding: 15px;">
      <h2 style="color:var(--gold); margin-bottom:10px;">éŠæˆ²å•†åŸ</h2>

      <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button class="modal-btn" id="tabTitle" style="margin:0; background:var(--red);"
          onclick="switchShop('title')">ç¨±è™Ÿ</button>
        <button class="modal-btn" id="tabEffect" style="margin:0; background:#444;"
          onclick="switchShop('effect')">æ’è¡Œæ¦œç‰¹æ•ˆ</button>
      </div>

      <div id="shopList" style="max-height: 300px; overflow-y: auto;">
      </div>

      <button class="modal-btn" style="background:#222; margin-top:10px; border:1px solid #444;"
        onclick="closeShop()">é›¢é–‹å•†åŸ</button>
    </div>
  </div>

  <div id="nameModal" class="modal">
    <div class="modal-content">
      <h2 style="color:var(--gold);">è«‹è¼¸å…¥éŠæˆ²æš±ç¨±</h2>
      <p style="color:#ccc; font-size:14px;">ç”¨æ–¼æ’è¡Œæ¦œé¡¯ç¤º</p>
      <input type="text" id="nicknameInput" placeholder="æœ€å¤š8å€‹å­—" maxlength="8">
      <button class="modal-btn" style="background:var(--red);" onclick="saveNewPlayer()">é€²å…¥éŠæˆ²</button>
    </div>
  </div>

  <audio id="sndCash" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

  <script>
    const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];

    const firebaseConfig = {
      apiKey: _k.join(''),
      authDomain: "game-80d68.firebaseapp.com",
      projectId: "game-80d68",
      storageBucket: "game-80d68.firebasestorage.app",
      messagingSenderId: "636332967920",
      appId: "1:636332967920:web:29e5600daf4db0ab613f35",
      measurementId: "G-MJZ4PGEHSQ"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    function updateMainBalance() {
      const balance = localStorage.getItem('sicbo_balance') || '5000';
      document.getElementById('mainBalance').textContent = Math.floor(parseFloat(balance)).toLocaleString();
    }

    function openModal() { document.getElementById('depositModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('depositModal').style.display = 'none'; }

    async function handleDeposit(amt) {
      let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
      balance += amt;
      localStorage.setItem('sicbo_balance', balance);
      const playerId = localStorage.getItem('player_id');
      if (playerId) {
        await db.collection("users").doc(playerId).update({ balance: balance });
      }
      document.getElementById('sndCash').play().catch(() => { });
      updateMainBalance();
      alert("é˜¿è¨˜å¹«ä½ åˆ·äº† " + amt.toLocaleString());
      closeModal();
    }
    // å•†å“å®šç¾©
    const SHOP_DATA = {
      title: [
        { id: 't_god', name: 'ğŸ² è³­ç¥', price: 1000000 },
        { id: 't_king', name: 'ğŸ‘‘ æ¢Ÿé›„', price: 500000 },
        { id: 't_rich', name: 'ğŸ’° åœŸè±ª', price: 100000 }
      ],
      effect: [
        { id: 'e_gold', name: 'âœ¨ é»ƒé‡‘å‘¼å¸', price: 20000000, class: 'fx-gold' },
        { id: 'e_fire', name: 'ğŸ”¥ åœ°ç„ç«', price: 8000000, class: 'fx-fire' },
        { id: 'e_neon', name: 'ğŸŒˆ éœ“è™¹æ¥µå…‰', price: 30, class: 'fx-neon' }
      ]
    };

    let currentShopTab = 'title';

    function switchShop(tab) {
      currentShopTab = tab;
      document.getElementById('tabTitle').style.background = tab === 'title' ? 'var(--red)' : '#444';
      document.getElementById('tabEffect').style.background = tab === 'effect' ? 'var(--red)' : '#444';
      renderShop();
    }

    function renderShop() {
      const shopList = document.getElementById('shopList');
      const myItems = JSON.parse(localStorage.getItem('my_assets') || '{}');
      const currentEquipped = JSON.parse(localStorage.getItem('equipped_assets') || '{"title":"","effect":""}');
      const now = Date.now();

      let html = '';
      SHOP_DATA[currentShopTab].forEach(item => {
        const expiry = myItems[item.id] || 0;
        const isOwned = now < expiry;
        const isEquipped = (currentShopTab === 'title' ? currentEquipped.title : currentEquipped.effect) === item.id;

        html += `
        <div style="display:flex; justify-content:space-between; align-items:center; border:1px solid #444; padding:12px; margin-bottom:8px; border-radius:10px; background:rgba(0,0,0,0.3);">
          <div style="text-align:left;">
            <div style="color:var(--gold); font-weight:bold;">${item.name}</div>
            <div style="color:#aaa; font-size:11px;">${isOwned ? 'å‰©é¤˜: ' + Math.ceil((expiry - now) / (1000 * 60 * 60 * 24)) + 'å¤©' : 'åƒ¹æ ¼: ğŸ’ ' + item.price.toLocaleString()}</div>
          </div>
          <div>
            ${isOwned ?
            `<button class="equip-btn" onclick="equipAsset('${currentShopTab}', '${item.id}')">${isEquipped ? 'ä½¿ç”¨ä¸­' : 'è£å‚™'}</button>` :
            `<button class="buy-btn" onclick="buyAsset('${currentShopTab}', '${item.id}', ${item.price})">è³¼è²·</button>`
          }
          </div>
        </div>
      `;
      });
      shopList.innerHTML = html;
    }

    // è³¼è²·èˆ‡è£å‚™é‚è¼¯
    async function buyAsset(type, id, price) {
      let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;
      if (balance < price) return alert("éŒ¢ä¸å¤ ï¼ä¸å€ŸéŒ¢å–”ï¼");
      if (!confirm("ç¢ºå®šè³¼è²· 7 å¤©ä½¿ç”¨æ¬Šå—ï¼Ÿ")) return;

      balance -= price;
      const expiry = Date.now() + (7 * 24 * 60 * 60 * 1000);

      // æ›´æ–°æœ¬åœ°
      let myAssets = JSON.parse(localStorage.getItem('my_assets') || '{}');
      myAssets[id] = expiry;
      localStorage.setItem('my_assets', JSON.stringify(myAssets));
      localStorage.setItem('sicbo_balance', balance);

      // åŒæ­¥ Firebase
      const playerId = localStorage.getItem('player_id');
      if (playerId) {
        await db.collection("users").doc(playerId).update({
          balance: balance,
          assets: myAssets
        });
      }

      updateMainBalance();
      renderShop();
      alert("è³¼è²·æˆåŠŸï¼");
    }

    async function equipAsset(type, id) {
      let equipped = JSON.parse(localStorage.getItem('equipped_assets') || '{"title":"","effect":""}');
      equipped[type] = id;
      localStorage.setItem('equipped_assets', JSON.stringify(equipped));

      // åŒæ­¥åˆ°æ’è¡Œæ¦œèˆ‡é¡¯ç¤º
      const playerId = localStorage.getItem('player_id');
      if (playerId) {
        // é€™è£¡æˆ‘å€‘æŠŠç¨±è™Ÿèˆ‡ç‰¹æ•ˆçš„ class å­˜å…¥ Firebase
        const titleObj = SHOP_DATA.title.find(t => t.id === equipped.title);
        const effectObj = SHOP_DATA.effect.find(e => e.id === equipped.effect);

        const updateData = {
          equipped_title: titleObj ? titleObj.name : "",
          equipped_fx: effectObj ? effectObj.class : ""
        };

        await db.collection("users").doc(playerId).update(updateData);
      }

      renderShop();
      loadRanking();
      alert("è£å‚™æˆåŠŸï¼");
      checkUserStatus();
    }
    // æ’è¡Œæ¦œé¡¯ç¤ºåˆ‡æ›
    async function toggleRank() {
      const sidebar = document.getElementById('rankSidebar');
      const overlay = document.getElementById('rankOverlay');

      if (sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
      } else {
        sidebar.classList.add('active');
        overlay.style.display = 'block';
        loadRanking(); // é–‹å•Ÿæ™‚æŠ“å–æœ€æ–°æ’å
      }
    }

    // å¾ Firebase æŠ“å–å‰ 10 å
    async function loadRanking() {
      const rankList = document.getElementById('rankList');
      try {
        const snapshot = await db.collection("users").orderBy("balance", "desc").limit(10).get();
        let html = '';
        let i = 1;

        // ä¿®æ”¹ loadRanking å…§éƒ¨çš„ HTML ç”Ÿæˆéƒ¨åˆ†
        snapshot.forEach(doc => {
          const data = doc.data();
          // ç‰¹æ•ˆèˆ‡ç¨±è™Ÿè™•ç†
          const fxClass = data.equipped_fx || "";
          const titlePrefix = data.equipped_title ? `${data.equipped_title} ` : "";

          html += `
    <div class="rank-item ${fxClass}">
      <div class="rank-info">
        <span class="rank-num">${i === 1 ? 'ğŸ†' : i}</span>
        <span class="rank-name">${titlePrefix}${data.name || 'ç„¡åæ°'}</span>
      </div>
      <span class="rank-bal">ğŸ’${Math.floor(data.balance).toLocaleString()}</span>
    </div>
  `;
          i++;
        });
        rankList.innerHTML = html || '<p style="text-align:center; color:#888;">å°šç„¡æ’åæ•¸æ“š</p>';
      } catch (e) {
        rankList.innerHTML = '<p style="text-align:center; color:red;">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    async function checkUserStatus() {
      let playerId = localStorage.getItem('player_id');

      // --- é—œéµä¿®æ­£ï¼šå¦‚æœæ²’æœ‰ IDï¼Œä»£è¡¨æ˜¯æ–°ç©å®¶ï¼Œç›´æ¥å½ˆå‡ºè¦–çª— ---
      if (!playerId || playerId === "null") {
        document.getElementById('nameModal').style.display = 'flex';
        updateMainBalance();
        return;
      }

      try {
        const doc = await db.collection("users").doc(playerId).get();
        if (doc.exists) {
          const cloudData = doc.data();
          const localBal = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
          const cloudBal = cloudData.balance;

          localStorage.setItem('player_name', cloudData.name);

          if (cloudBal !== undefined && cloudBal > localBal) {
            localStorage.setItem('sicbo_balance', cloudBal);
          }
          else if (cloudBal !== undefined && localBal > cloudBal) {
            await db.collection("users").doc(playerId).update({ balance: localBal });
          }

          // --- å•†åŸç‰¹æ•ˆèˆ‡ç¨±è™Ÿé¡¯ç¤ºé‚è¼¯ ---
          const welcomeEl = document.getElementById('welcomeUser');
          const fxClass = cloudData.equipped_fx || ""; // å–å¾—ç‰¹æ•ˆ Class (ä¾‹å¦‚ fx-fire)
          const titlePrefix = cloudData.equipped_title ? `${cloudData.equipped_title} ` : ""; // å–å¾—ç¨±è™Ÿ
          
          // æ›´æ–°é¦–é é¡¯ç¤ºæ–‡å­—
          welcomeEl.textContent = `${titlePrefix}${cloudData.name}`;
          
          // æ›´æ–°é¦–é é¡¯ç¤ºç‰¹æ•ˆ
          // å…ˆæ¸…é™¤æ‰€æœ‰èˆŠæ¨£å¼èˆ‡ Class
          welcomeEl.classList.remove('fx-fire', 'fx-neon', 'fx-gold', 'rank-item');
          welcomeEl.style.cssText = ""; // æ¸…é™¤ä¹‹å‰å¯èƒ½æ®˜ç•™çš„ inline style
          
          if (fxClass) {
            welcomeEl.classList.add(fxClass);
            
            // è®“ç‰¹æ•ˆå‘ˆç¾ã€Œå€å¡Šæ„Ÿã€
            welcomeEl.style.display = "inline-block";
            welcomeEl.style.padding = "8px 20px";
            welcomeEl.style.borderRadius = "25px";
            welcomeEl.style.fontWeight = "bold";
            welcomeEl.style.marginTop = "10px";
            welcomeEl.style.fontSize = "16px";
            welcomeEl.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";

            // é‡å°ä¸åŒç‰¹æ•ˆå¼·åˆ¶è£œå¼·èƒŒæ™¯ï¼Œç¢ºä¿ã€Œç‰¹æ•ˆæ„Ÿã€åè¶³
            if (fxClass === 'fx-fire') {
              welcomeEl.style.background = "linear-gradient(90deg, #4a0404, #ff4757)";
              welcomeEl.style.boxShadow = "0 0 15px rgba(255, 71, 87, 0.6)";
            } else if (fxClass === 'fx-gold') {
              welcomeEl.style.background = "linear-gradient(110deg, #2a2200, #6b5500, #2a2200)";
              welcomeEl.style.backgroundSize = "200% auto";
              welcomeEl.style.color = "#fff";
            } else if (fxClass === 'fx-neon') {
              welcomeEl.style.background = "rgba(0,0,0,0.6)";
              // fx-neon æœ¬èº«å¸¶æœ‰ animationï¼Œé€™è£¡ä¸»è¦é  Class é©…å‹•
            }
          } else {
            // ç„¡ç‰¹æ•ˆæ™‚çš„é è¨­æ–‡å­—æ¨£å¼
            welcomeEl.style.color = "#ccc";
            welcomeEl.style.fontSize = "14px";
          }

          updateMainBalance();
        } else {
          document.getElementById('nameModal').style.display = 'flex';
        }
      } catch (e) {
        console.error("Firebase é€£ç·šå¤±æ•—", e);
        const localName = localStorage.getItem('player_name');
        if (localName) {
          document.getElementById('welcomeUser').textContent = `æ­¡è¿å›ä¾†(é›¢ç·š)ï¼Œ${localName}`;
        } else {
          document.getElementById('nameModal').style.display = 'flex';
        }
        updateMainBalance();
      }
    }
    // --- å•†åŸåŠŸèƒ½ ---
    function openShop() { document.getElementById('shopModal').style.display = 'flex'; }
    function closeShop() { document.getElementById('shopModal').style.display = 'none'; }

    async function buyTitle(titleName, price) {
      let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 0;

      if (balance < price) {
        alert("éŒ¢ä¸å¤ å•¦");
        return;
      }

      if (!confirm(`ç¢ºå®šè¦èŠ±è²» ğŸ’ ${price.toLocaleString()} è³¼è²·ã€Œ${titleName}ã€å—ï¼Ÿ`)) return;

      // æ‰£éŒ¢
      balance -= price;
      localStorage.setItem('sicbo_balance', balance);

      // æ›´æ–°é›²ç«¯åå­— (åŠ ä¸Šç¨±è™Ÿ)
      const playerId = localStorage.getItem('player_id');
      const baseName = localStorage.getItem('player_name') || 'ç„¡åæ°';
      const newFullName = `${titleName} ${baseName}`;

      if (playerId) {
        try {
          await db.collection("users").doc(playerId).update({
            balance: balance,
            name: newFullName // æ›´æ–°å«æœ‰ç¨±è™Ÿçš„åå­—
          });
          localStorage.setItem('player_name', newFullName); // æœ¬åœ°åŒæ­¥æ›´æ–°
          alert("è³¼è²·æˆåŠŸï¼ç¨±è™Ÿå·²å¥—ç”¨è‡³æ’è¡Œæ¦œã€‚");
        } catch (e) {
          console.error("å•†åŸæ›´æ–°å¤±æ•—", e);
          alert("é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œä½†é¤˜é¡å·²æ‰£é™¤(æœ¬åœ°)");
        }
      }

      updateMainBalance();
      document.getElementById('welcomeUser').textContent = `æ­¡è¿å›ä¾†ï¼Œ${newFullName}`;
      closeShop();
      loadRanking(); // é‡æ–°æ•´ç†æ’è¡Œæ¦œçœ‹åˆ°æ–°ç¨±è™Ÿ
    }
    // --- é—œéµä¿®å¾©ï¼šå„²å­˜æš±ç¨± ---
    async function saveNewPlayer() {
      const nameInput = document.getElementById('nicknameInput');
      const name = nameInput.value.trim();
      if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");

      // 1. å¼·åˆ¶é‡æ–°ç²å–ä¸€æ¬¡ IDï¼Œå¦‚æœæ²’æœ‰å°±åœ°ç”Ÿæˆ
      let playerId = localStorage.getItem('player_id');
      if (!playerId || playerId === "" || playerId === "null") {
        playerId = 'u' + Date.now() + Math.floor(Math.random() * 1000);
        localStorage.setItem('player_id', playerId);
      }

      const localBal = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;

      try {
        // 2. å…ˆå­˜æœ¬åœ°ï¼Œç¢ºä¿ UI èƒ½å…ˆå‹•
        localStorage.setItem('player_name', name);
        localStorage.setItem('sicbo_balance', localBal);

        // 3. åŸ·è¡Œ Firebase å¯«å…¥ (æ­¤æ™‚ playerId çµ•å°æœ‰å€¼)
        await db.collection("users").doc(playerId).set({
          name: name,
          balance: localBal,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('welcomeUser').textContent = `æ­¡è¿ï¼Œ${name}`;
        updateMainBalance();
      } catch (e) {
        console.error("å„²å­˜å¤±æ•—:", e);
        // è¬ä¸€ Firebase çœŸçš„é‚„æ˜¯å¤±æ•—ï¼Œè‡³å°‘è¦è®“ç©å®¶é—œæ‰è¦–çª—é€²å…¥éŠæˆ²
        document.getElementById('nameModal').style.display = 'none';
        document.getElementById('welcomeUser').textContent = `æ­¡è¿(æœ¬åœ°)ï¼Œ${name}`;
        updateMainBalance();
      }
    }

    window.onload = function () {
      updateMainBalance();
      checkUserStatus();
    };

    document.addEventListener('click', function (e) {
      let target = e.target.closest('a');
      if (target && target.href && target.getAttribute('href') !== '#') {
        e.preventDefault();
        window.location.href = target.href;
      }
    }, false);

    window.addEventListener('storage', (e) => {
      if (e.key === 'sicbo_balance') updateMainBalance();
    });
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
<title>é˜¿è¨˜ä¸‰ç¼ºä¸€</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="é˜¿è¨˜å¨›æ¨‚åŸ">

<meta name="mobile-web-app-capable" content="yes">
<style>
  :root { 
    --gold: #ffd86b; 
    --dark-red: #4a0404;
    --card-bg: rgba(255, 255, 255, 0.1);
    --red: #ff4757;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; padding: 0;
    background: radial-gradient(circle at center, #2a0202, #050000);
    color: #fff; font-family: "Microsoft JhengHei", Arial;
    height: 100dvh; width: 100vw;
    display: flex; flex-direction: column;
    overflow: hidden; 
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }

  .header {
    height: 50px; flex-shrink: 0;
    background: linear-gradient(to bottom, #5c0a0a, #2a0202);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 15px; border-bottom: 2px solid var(--gold);
    z-index: 100;
  }
  .logo { font-size: 18px; font-weight: 900; color: var(--gold); }
  .balance-display { background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px; border: 1px solid var(--gold); font-size: 15px; color: var(--gold); font-weight: bold; cursor: pointer; }

  .container {
    flex: 1; display: flex; flex-direction: column;
    padding: 10px; width: 100%; max-width: 800px; margin: 0 auto;
    overflow: hidden;
  }

  .welcome-msg { font-size: 14px; color: #ccc; text-align: center; margin-bottom: 8px; }

  .game-grid {
    flex: 1; display: grid;
    grid-template-columns: repeat(3, 1fr); gap: 10px; 
    align-content: start; overflow-y: auto; padding-bottom: 10px;
  }

  .game-card {
    background: var(--card-bg); border: 1px solid #444; border-radius: 12px;
    display: flex; flex-direction: column; text-decoration: none; color: inherit;
    min-height: 85px; transition: transform 0.1s;
  }
  
  .game-img { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 28px; }
  .game-info { height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); border-radius: 0 0 12px 12px; }
  .game-title { font-size: 12px; color: var(--gold); font-weight: bold; }

  .deposit-area { width: 100%; display: flex; gap: 10px; flex-shrink: 0; padding: 10px 0; }
  .btn-deposit { flex: 2; padding: 12px; border-radius: 12px; border: 2px solid var(--gold); background: linear-gradient(#ff4757, #b91c1c); color: #fff; font-size: 18px; font-weight: 900; }
  .btn-rank { flex: 1; padding: 12px; border-radius: 12px; border: 2px solid var(--gold); background: linear-gradient(#f59e0b, #92400e); color: #fff; font-size: 15px; font-weight: 900; }

  .footer { text-align: center; padding: 5px 0; font-size: 10px; color: #444; }

  /* --- æ’è¡Œæ¦œå´é‚Šæ¬„ä¿®æ­£ --- */
  #rankOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); display: none; z-index: 2999;
  }

  #rankSidebar {
    position: fixed; top: 0; right: -100%; /* åˆå§‹éš±è—åœ¨å³å´ */
    width: 80%; max-width: 320px; height: 100%;
    background: #1a0202; border-left: 2px solid var(--gold);
    z-index: 3000; transition: 0.3s ease; 
    display: flex; flex-direction: column; padding: 20px;
  }
  #rankSidebar.active { right: 0; } /* å•Ÿå‹•æ™‚æ‹‰å›è¢å¹• */

  .rank-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gold); padding-bottom: 10px; }
  .rank-list { flex: 1; overflow-y: auto; margin-top: 10px; }
  .rank-item { display: flex; justify-content: space-between; padding: 12px 5px; border-bottom: 1px solid rgba(255,216,107,0.1); font-size: 14px; }
  .rank-num { color: var(--gold); font-weight: bold; width: 25px; }
  .rank-name { flex: 1; margin-left: 5px; }
  .rank-bal { color: #fff; }
  .close-rank { font-size: 30px; color: var(--gold); cursor: pointer; }

  /* æ©«å‘æ¨¡å¼èª¿æ•´ */
  @media (orientation: landscape) {
    .game-grid { grid-template-columns: repeat(5, 1fr); }
    .game-card { min-height: 65px; }
    .game-img { font-size: 22px; }
  }

  .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
  .modal-content { background: #1a1a1a; border: 2px solid var(--gold); padding: 20px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }
  .modal-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; color: #fff; }
</style>
</head>
<body>

<div class="header">
  <div class="logo">é˜¿è¨˜ä¸‰ç¼ºä¸€</div>
  <div class="balance-display" onclick="toggleRank()">ğŸ’ <span id="mainBalance">0</span></div>
</div>
<div>
<marquee style="flex:1; color:var(--gold);">ç·šä¸Šæ¸¬è©¦ç‰ˆ</marquee>
</div>

<div class="container">
  <div class="welcome-msg" id="welcomeUser">é¸æ“‡éŠæˆ²</div>
  
  <div class="game-grid">
    <a href="sicbo.html" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #0a5c32, #084325);">ğŸ²</div>
      <div class="game-info">
        <div class="game-title">éª°å¯¶</div>
      </div>
    </a>

    <a href="#" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #4a0404, #2a0202);">ğŸ°</div>
      <div class="game-info">
        <div class="game-title">(æš«ç„¡)777æ‹‰éœ¸æ©Ÿ</div>
      </div>
    </a>
    <a href="horse.html" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #1e3a8a, #1e1b4b);">ğŸ</div>
      <div class="game-info">
        <div class="game-title">è³½é¦¬å ´</div>
      </div>
    </a>
     <a href="gemslot.html" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #5b8a1e, #d1f51e);">ğŸ’</div>
      <div class="game-info">
        <div class="game-title">å¯¶çŸ³ç¤¦å‘</div>
      </div>
    </a>
    <a href="#" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #0f3fc4, #12e7f6);">ğŸ²</div>
      <div class="game-info">
        <div class="game-title">(æš«ç„¡)æ¶ˆæ¶ˆæ¨‚</div>
      </div>
    </a>
    <a href="mahj.html" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #e833a2, #d26019);">ğŸ€„</div>
      <div class="game-info">
        <div class="game-title">éº»å°‡æ¶ˆæ¶ˆæ¨‚</div>
      </div>
    </a>
      <a href="heart.html" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #fcb1df, #f5ac7f);">â¤ï¸</div>
      <div class="game-info">
        <div class="game-title">æ„›å¿ƒ</div>
      </div>
    </a>
    <a href="#" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #f1c1c1, #56f19e);">ğŸ°</div>
      <div class="game-info">
        <div class="game-title">(æš«ç„¡)é€£é€£çœ‹</div>
      </div>
    </a>
    <a href="#" class="game-card">
      <div class="game-img" style="background: linear-gradient(45deg, #312222, #bad7c7);">ğŸ§§</div>
      <div class="game-info">
        <div class="game-title">(æš«ç„¡)æœªå®Œæˆåˆ®åˆ®æ¨‚</div>
      </div>
    </a>
  </div>

  <div class="deposit-area">
    <button class="btn-deposit" onclick="openModal()">ğŸ’¸ è¬€å‰é˜¿</button>
    <button class="btn-rank" onclick="toggleRank()">ğŸ† æ’è¡Œ</button>
  </div>
</div>

<div class="footer">
  &copy; é˜¿è¨˜å¨›æ¨‚åŸ
</div>

<div id="rankOverlay" onclick="toggleRank()"></div>
<div id="rankSidebar">
  <div class="rank-header">
    <h2 style="color:var(--gold); margin:0;">ğŸ’æ’è¡Œæ¦œ</h2>
    <span class="close-rank" onclick="toggleRank()">&times;</span>
  </div>
  <div class="rank-list" id="rankList">
    <p style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</p>
  </div>
</div>

<div id="depositModal" class="modal">
  <div class="modal-content">
    <h2 style="color:var(--gold); margin-bottom:15px; font-size: 22px;">åˆ·é˜¿è¨˜çš„å¡</h2>
    <button class="modal-btn" style="background:#3b82f6;" onclick="handleDeposit(10000)">å„²å€¼ 10,000</button>
    <button class="modal-btn" style="background:#a855f7;" onclick="handleDeposit(50000)">å„²å€¼ 50,000</button>
    <button class="modal-btn" style="background:#f59e0b;" onclick="handleDeposit(100000)">å„²å€¼ 100,000</button>
    <button class="modal-btn" style="background:#444; color:#ccc;" onclick="closeModal()">ç®—äº†</button>
  </div>
</div>

<div id="nameModal" class="modal">
  <div class="modal-content">
    <h2 style="color:var(--gold);">è«‹è¼¸å…¥éŠæˆ²æš±ç¨±</h2>
    <p style="color:#ccc; font-size:14px;">è«‹å‹¿è¼¸å…¥çœŸäººåï¼Œæ’è¡Œæ¦œæœƒé¡¯ç¤º</p>
    <input type="text" id="nicknameInput" placeholder="æœ€å¤š8å€‹å­—" maxlength="8">
    <button class="modal-btn" style="background:var(--red);" onclick="saveNewPlayer()">é€²å…¥éŠæˆ²</button>
  </div>
</div>

<audio id="sndCash" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDSRfVAuWCWCUd1NJopJ6wHvsqsAM4UzJA",
    authDomain: "game-80d68.firebaseapp.com",
    projectId: "game-80d68",
    storageBucket: "game-80d68.firebasestorage.app",
    messagingSenderId: "636332967920",
    appId: "1:636332967920:web:29e5600daf4db0ab613f35",
    measurementId: "G-MJZ4PGEHSQ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function updateMainBalance() {
    const balance = localStorage.getItem('sicbo_balance') || '5000';
    document.getElementById('mainBalance').textContent = Math.floor(parseFloat(balance)).toLocaleString();
  }

  function openModal() { document.getElementById('depositModal').style.display = 'flex'; }
  function closeModal() { document.getElementById('depositModal').style.display = 'none'; }

  async function handleDeposit(amt) {
    let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
    balance += amt;
    localStorage.setItem('sicbo_balance', balance); 
    const playerId = localStorage.getItem('player_id');
    if (playerId) {
      await db.collection("users").doc(playerId).update({ balance: balance });
    }
    document.getElementById('sndCash').play().catch(()=>{});
    updateMainBalance();
    alert("é˜¿è¨˜å¹«ä½ åˆ·äº† " + amt.toLocaleString());
    closeModal();
  }

  // æ’è¡Œæ¦œé¡¯ç¤ºåˆ‡æ›
  async function toggleRank() {
    const sidebar = document.getElementById('rankSidebar');
    const overlay = document.getElementById('rankOverlay');
    
    if (sidebar.classList.contains('active')) {
      sidebar.classList.remove('active');
      overlay.style.display = 'none';
    } else {
      sidebar.classList.add('active');
      overlay.style.display = 'block';
      loadRanking(); // é–‹å•Ÿæ™‚æŠ“å–æœ€æ–°æ’å
    }
  }

  // å¾ Firebase æŠ“å–å‰ 10 å
  async function loadRanking() {
    const rankList = document.getElementById('rankList');
    try {
      const snapshot = await db.collection("users").orderBy("balance", "desc").limit(10).get();
      let html = '';
      let i = 1;
      snapshot.forEach(doc => {
        const data = doc.data();
        html += `
          <div class="rank-item">
            <span class="rank-num">${i}</span>
            <span class="rank-name">${data.name || 'ç„¡åæ°'}</span>
            <span class="rank-bal">$${Math.floor(data.balance).toLocaleString()}</span>
          </div>
        `;
        i++;
      });
      rankList.innerHTML = html || '<p style="text-align:center; color:#888;">å°šç„¡æ’åæ•¸æ“š</p>';
    } catch (e) {
      rankList.innerHTML = '<p style="text-align:center; color:red;">è¼‰å…¥å¤±æ•—</p>';
    }
  }

  async function checkUserStatus() {
    let playerId = localStorage.getItem('player_id');
    
    // --- é—œéµä¿®æ­£ï¼šå¦‚æœæ²’æœ‰ IDï¼Œä»£è¡¨æ˜¯æ–°ç©å®¶ï¼Œç›´æ¥å½ˆå‡ºè¦–çª— ---
    if (!playerId || playerId === "null") {
      document.getElementById('nameModal').style.display = 'flex';
      updateMainBalance();
      return; 
    }

    try {
        const doc = await db.collection("users").doc(playerId).get();
        if (doc.exists) {
            const cloudData = doc.data();
            const localBal = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
            const cloudBal = cloudData.balance;

            localStorage.setItem('player_name', cloudData.name);

            if (cloudBal !== undefined && cloudBal > localBal) {
                localStorage.setItem('sicbo_balance', cloudBal);
            } 
            else if (cloudBal !== undefined && localBal > cloudBal) {
                await db.collection("users").doc(playerId).update({ balance: localBal });
            }

            document.getElementById('welcomeUser').textContent = `æ­¡è¿å›ä¾†ï¼Œ${cloudData.name}`;
            updateMainBalance();
        } else {
            // å¦‚æœæœ‰ ID ä½†é›²ç«¯æŸ¥ç„¡è³‡æ–™ï¼Œä¹Ÿè¦–ç‚ºæ–°ç©å®¶
            document.getElementById('nameModal').style.display = 'flex';
        }
    } catch (e) {
      console.error("Firebase é€£ç·šå¤±æ•—", e);
      const localName = localStorage.getItem('player_name');
      if (localName) {
        document.getElementById('welcomeUser').textContent = `æ­¡è¿å›ä¾†(é›¢ç·š)ï¼Œ${localName}`;
      } else {
        // é›¢ç·šç‹€æ…‹ä¸”æœ¬åœ°ä¹Ÿæ²’å­˜éåå­—ï¼Œä¸€å®šè¦å½ˆå‡ºè¦–çª—
        document.getElementById('nameModal').style.display = 'flex';
      }
      updateMainBalance();
    }
  }

  // --- é—œéµä¿®å¾©ï¼šå„²å­˜æš±ç¨± ---
  async function saveNewPlayer() {
    const nameInput = document.getElementById('nicknameInput');
    const name = nameInput.value.trim();
    if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");

    // 1. å¼·åˆ¶é‡æ–°ç²å–ä¸€æ¬¡ IDï¼Œå¦‚æœæ²’æœ‰å°±åœ°ç”Ÿæˆ
    let playerId = localStorage.getItem('player_id');
    if (!playerId || playerId === "" || playerId === "null") {
      playerId = 'u' + Date.now() + Math.floor(Math.random() * 1000);
      localStorage.setItem('player_id', playerId);
    }

    const localBal = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;

    try {
      // 2. å…ˆå­˜æœ¬åœ°ï¼Œç¢ºä¿ UI èƒ½å…ˆå‹•
      localStorage.setItem('player_name', name);
      localStorage.setItem('sicbo_balance', localBal);

      // 3. åŸ·è¡Œ Firebase å¯«å…¥ (æ­¤æ™‚ playerId çµ•å°æœ‰å€¼)
      await db.collection("users").doc(playerId).set({
        name: name,
        balance: localBal,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById('nameModal').style.display = 'none';
      document.getElementById('welcomeUser').textContent = `æ­¡è¿ï¼Œ${name}`;
      updateMainBalance();
    } catch (e) {
      console.error("å„²å­˜å¤±æ•—:", e);
      // è¬ä¸€ Firebase çœŸçš„é‚„æ˜¯å¤±æ•—ï¼Œè‡³å°‘è¦è®“ç©å®¶é—œæ‰è¦–çª—é€²å…¥éŠæˆ²
      document.getElementById('nameModal').style.display = 'none';
      document.getElementById('welcomeUser').textContent = `æ­¡è¿(æœ¬åœ°)ï¼Œ${name}`;
      updateMainBalance();
    }
  }

  window.onload = function() {
    updateMainBalance();
    checkUserStatus();
  };

  document.addEventListener('click', function(e) {
    let target = e.target.closest('a');
    if (target && target.href && target.getAttribute('href') !== '#') {
        e.preventDefault();
        window.location.href = target.href;
    }
  }, false);

  window.addEventListener('storage', (e) => {
    if (e.key === 'sicbo_balance') updateMainBalance();
  });
</script>
</body>
</html>
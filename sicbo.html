<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>

<title>éª°å¯¶</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="é˜¿è¨˜å¨›æ¨‚åŸ">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root { --table-green: #0a5c32; --gold: #ffd86b; --red: #ff4757; --green: #2ecc71; }
  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    margin: 0; padding: 0; 
    touch-action: manipulation;
  }
  body { height: 100dvh; width: 100vw; font-family: "Microsoft JhengHei", Arial; background: #05140b; color: #fff; display: flex; flex-direction: column; overflow: hidden; }
  
  .topbar { 
    height: 50px; 
    background: linear-gradient(#4a0404, #2a0202); 
    display: flex; 
    align-items: center; 
    padding-left: calc(15px + env(safe-area-inset-left)); 
    padding-right: calc(15px + env(safe-area-inset-right)); 
    gap: 15px; 
    border-bottom: 2px solid #5c0a0a; 
    flex-shrink: 0; 
  }
  .sound-toggle {
    background: rgba(255,255,255,0.1);
    padding: 4px 10px;
    border-radius: 8px;
    border: 1px solid var(--gold);
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
  }
  @media (orientation: portrait) {
    .portrait-tip {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
      background: #1a0505; z-index: 999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; text-align: center; color: #fff;
    }
  }
  @media (orientation: landscape) { .portrait-tip { display: none; } }
  .balance-box { background: rgba(0,0,0,0.5); border: 1px solid var(--gold); border-radius: 15px; padding: 4px 15px; color: var(--gold); font-weight: bold; }
  
  #centerDisplay { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(0, 0, 0, 0.95); border: 4px solid var(--gold); border-radius: 20px; padding: 40px; z-index: 3000; text-align: center; display: none; box-shadow: 0 0 50px #000; transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
  #centerDisplay.show { display: block; transform: translate(-50%, -50%) scale(1.1); }
  .big-dice { font-size: 80px; letter-spacing: 10px; margin-bottom: 10px; text-shadow: 0 0 20px #fff; }
  .big-result { font-size: 42px; font-weight: 900; color: var(--gold); }
  
  #winAmountEffect { position: fixed; top: 65%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; font-weight: 900; color: #fff000; text-shadow: 0 0 20px #ffae00, 0 0 40px #ffae00, 2px 2px 10px #000; z-index: 5000; display: none; pointer-events: none; animation: floatUp 1.8s ease-out forwards; }
  .triple-win-scale { transform: translate(-50%, -50%) scale(1.5) !important; color: #ff4757 !important; }
  @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 20%); } 30% { opacity: 1; transform: translate(-50%, -55%); } 70% { opacity: 1; transform: translate(-50%, -60%); } 100% { opacity: 0; transform: translate(-50%, -100%); } }

  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; }
  
  /* å´é‚Šæ¬„å„ªåŒ– */
  .main-layout { display: flex; flex: 1; padding: 5px; padding-left: calc(5px + env(safe-area-inset-left)); padding-right: calc(5px + env(safe-area-inset-right)); gap: 5px; overflow: hidden; }
  .history-sidebar { width: 140px; background: rgba(0,0,0,0.4); border-radius: 8px; display: flex; flex-direction: column; padding: 5px; overflow: hidden; }
  #historyList { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
  .hist-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 2px; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; }
  
  .miss-box { margin-top: 5px; background: #000; border: 1px solid #444; border-radius: 5px; padding: 5px; text-align: center; flex-shrink: 0; }
  .miss-box div:first-child { font-size: 10px; color: #aaa; }
  .miss-box #missCountText { font-size: 18px; font-weight: bold; color: #ff4757; }

  /* åœéª°å¾—ä¸»æŒ‰éˆ•æ¨£å¼ */
  .triple-winner-btn {
    margin-top: 5px;
    background: linear-gradient(to bottom, #ff4757, #b91c1c);
    border: 1px solid var(--gold);
    border-radius: 5px;
    padding: 4px;
    cursor: pointer;
    text-align: center;
    flex-shrink: 0;
    min-height: 45px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .triple-winner-btn span { font-size: 9px; color: #fff; display: block; }
  #latestWinnerInfo { font-size: 11px; color: var(--gold); font-weight: bold; }

  /* è‹±é›„æ¦œå½ˆçª—ç´€éŒ„ */
  .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; font-size: 14px; }
  .rank-name { color: var(--gold); }
  .rank-amt { color: var(--green); font-weight: bold; }

  .full-hist-btn { background: var(--gold); border: none; color: #000; font-weight: bold; font-size: 12px; padding: 8px; border-radius: 5px; margin-top: 5px; cursor: pointer; }

  #fullHistoryOverlay, #tripleRankOverlay { background: rgba(0,0,0,0.95); flex-direction: column; padding: 20px; }
  #fullHistoryList, #tripleRankList { width: 100%; max-width: 400px; max-height: 70vh; overflow-y: auto; background: #222; border-radius: 10px; }

  .sum-big { color: var(--gold); } 
  .sum-small { color: #5cc9ff; } 
  .sum-triple { background: var(--red); color: #fff; border-radius: 3px; padding: 0 2px; }
  .table-container { flex: 1; display: flex; flex-direction: column; position: relative; }
  .betting-table { flex: 1; background: var(--table-green); border: 3px solid #084325; border-radius: 15px; display: grid; grid-template-rows: repeat(4, 1fr); gap: 1px; padding: 2px; }
  .bet-row { display: flex; gap: 1px; }
  .bet-cell { flex: 1; border: 1px solid rgba(255,215,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; font-weight: bold; }
  .odds-label { font-size: 9px; color: rgba(255,255,255,0.6); font-weight: normal; }
  .chip-on-cell { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 32px; height: 32px; border-radius: 50%; background: radial-gradient(circle, #ff4757, #b91c1c); border: 2px dashed #fff; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 10; }
  .timer-box { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: rgba(128,0,128,0.7); border: 3px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; color: var(--gold); }

  .footer-bar { height: 125px; background: linear-gradient(#333, #111); border-top: 2px solid #555; display: flex; align-items: center; padding: 0 10px; flex-shrink: 0; }
  .info-area { width: 80px; text-align: center; flex-shrink: 0; }
  .info-area div:first-child { font-size: 11px; color: var(--gold); }
  .info-area #totalBetText { font-size: 20px; font-weight: bold; }
  .chip-area { display: flex; gap: 10px; flex: 1; justify-content: center; align-items: center; }
  .chip-btn { width: 56px; height: 56px; border-radius: 50%; border: 3px solid #fff; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; transition: transform 0.1s; }
  .chip-btn.active { transform: translateY(-10px); border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
  .btn-area-row { display: flex; gap: 6px; height: 85px; flex-shrink: 0; width: 380px; }
  .btn-ui { flex: 1; height: 100%; border-radius: 10px; font-weight: 900; border: none; background: #eee; font-size: 17px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #000; }
  .btn-auto-active { background: var(--gold) !important; box-shadow: 0 0 12px var(--gold); }
</style>
</head>
<body>
<div class="portrait-tip">
  <div style="font-size: 50px;">ğŸ”„</div>
  <p style="margin-top: 20px;">æ©«è‘—ç©</p>
</div>

<div id="tripleRankOverlay" class="modal">
  <div style="color:var(--gold); font-size:20px; margin-bottom:15px; font-weight:bold;">ğŸ†æœ€è¿‘10æ¬¡åœéª°å¾—ä¸»</div>
  <div id="tripleRankList"></div>
  <button class="btn-ui" style="background:var(--gold); margin-top:20px; width:150px; height: 50px; flex: none;" onclick="closeModal('tripleRankOverlay')">è¿”å›</button>
</div>

<div id="fullHistoryOverlay" class="modal">
  <div style="color:var(--gold); font-size:24px; margin-bottom:15px; font-weight:bold;">å®Œæ•´é–‹éª°ç´€éŒ„</div>
  <div id="fullHistoryList"></div>
  <button class="btn-ui" style="background:var(--gold); margin-top:20px; width:150px; height: 50px; flex: none;" onclick="closeModal('fullHistoryOverlay')">é—œé–‰</button>
</div>

<audio id="sndChip" src="https://assets.mixkit.co/active_storage/sfx/3005/3005-preview.mp3" preload="auto"></audio>
<audio id="sndDice" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3" preload="auto"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="sndTriple" src="https://www.myinstants.com/media/sounds/explosion.mp3"></audio>
<audio id="sndTick" src="https://assets.mixkit.co/active_storage/sfx/1115/1115-preview.mp3" preload="auto"></audio>
<audio id="sndCash" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

<audio id="bgm1" src="background-music-434612.mp3" loop preload="auto"></audio>
<audio id="bgm2" src="soft-background-music-427252.mp3" loop preload="auto"></audio>
<audio id="bgm3" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" loop preload="auto"></audio>

<div id="centerDisplay">
  <div class="big-dice" id="bigDiceIcons"></div>
  <div class="big-result" id="bigResultText"></div>
</div>
<div id="winAmountEffect"></div>

<div class="topbar">
  <div class="sound-toggle" onclick="toggleMute()" id="soundIcon">ğŸ”Š</div>
  <div class="sound-toggle" onclick="cycleBGM()" id="bgmBtn">ğŸµ éŸ³æ¨‚ 1</div>
  <div class="balance-box">ğŸ’ <span id="balanceText">0</span></div>
  <div class="triple-winner-btn" onclick="showRank()">
        <span>ğŸ† æœ€æ–°åœéª°å¾—ä¸»</span>
        <div id="latestWinnerInfo">ç­‰å¾…ä¸­...</div>
    </div>
  <marquee style="flex:1; color:var(--gold);">è½‰æ©«çš„ç©</marquee>
  <a href="index.html" style="text-decoration:none;">
    <button style="background:none; border:1px solid #777; color:#ccc; border-radius:5px; padding:5px 12px; font-size:14px;">ğŸ  å›å¤§å»³</button>
  </a>
</div>

<div class="main-layout">
  <div class="history-sidebar">
    <div style="text-align:center; color:var(--gold); font-size:12px; font-weight:bold; padding-bottom:5px; border-bottom:1px solid #444;">é–‹éª°ç´€éŒ„</div>
    <div id="historyList"></div>
    
    

    <div class="miss-box">
        <div>æœªé–‹å±€æ•¸</div>
        <div id="missCountText">0</div>
    </div>
    <button class="full-hist-btn" onclick="openModal('fullHistoryOverlay')">å®Œæ•´ç´€éŒ„</button>
  </div>
  
  <div class="table-container">
    <div class="betting-table">
      <div class="bet-row">
        <div class="bet-cell" style="flex:1.2" onclick="placeBet('small')">å°<div class="odds-label">1:1</div><div id="chip-small"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_1')">111<div class="odds-label">1:210</div><div id="chip-triple_1"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_2')">222<div class="odds-label">1:210</div><div id="chip-triple_2"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_3')">333<div class="odds-label">1:210</div><div id="chip-triple_3"></div></div>
        <div class="bet-cell" style="background:rgba(255,216,107,0.1)" onclick="placeBet('anyTriple')">å…¨åœ<div class="odds-label">1:34</div><div id="chip-anyTriple"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_4')">444<div class="odds-label">1:210</div><div id="chip-triple_4"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_5')">555<div class="odds-label">1:210</div><div id="chip-triple_5"></div></div>
        <div class="bet-cell" onclick="placeBet('triple_6')">666<div class="odds-label">1:210</div><div id="chip-triple_6"></div></div>
        <div class="bet-cell" style="flex:1.2" onclick="placeBet('big')">å¤§<div class="odds-label">1:1</div><div id="chip-big"></div></div>
      </div>
      <div class="bet-row" id="sumRow"></div>
      <div class="bet-row" id="singleRow"></div>
    </div>
    <div class="timer-box" id="timer">20</div>
  </div>
</div>

<div class="footer-bar">
  <div class="info-area">
    <div>ç¸½æŠ¼æ³¨</div>
    <div id="totalBetText">0</div>
  </div>
  <div class="chip-area">
    <div class="chip-btn" style="background:#3b82f6;" onclick="selectChip(100, this)">100</div>
    <div class="chip-btn active" style="background:#a855f7;" onclick="selectChip(600, this)">600</div>
    <div class="chip-btn" style="background:#ef4444;" onclick="selectChip(1000, this)">1000</div>
    <div class="chip-btn" style="background:var(--green);" onclick="selectChip(6000, this)">6000</div>
  </div>
  <div class="btn-area-row">
    <button class="btn-ui" id="btnAuto" onclick="toggleAuto()">è‡ªå‹•ç©</button>
    <button class="btn-ui" style="background:var(--gold);" onclick="repeatBets()">çºŒæŠ¼</button>
    <button class="btn-ui" onclick="clearBets()">æ¸…é™¤</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>

<script>
// --- Firebase åˆå§‹åŒ– ---
const _k = ["AIzaSyDSRfVA", "uWCWCUd1NJop", "J6wHvsqsAM4UzJA"];

const firebaseConfig = {
  apiKey: _k.join(''),
  authDomain: "game-80d68.firebaseapp.com",
  projectId: "game-80d68",
  storageBucket: "game-80d68.firebasestorage.app",
  messagingSenderId: "636332967920",
  appId: "1:636332967920:web:29e5600daf4db0ab613f35",
  measurementId: "G-MJZ4PGEHSQ"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

// --- æ ¸å¿ƒè®Šæ•¸ ---
let balance = parseFloat(localStorage.getItem('sicbo_balance')) || 5000;
let historyData = JSON.parse(localStorage.getItem('sicbo_history')) || [];
let missCount = parseInt(localStorage.getItem('sicbo_triple_miss')) || 0; 
let currentChip = 600, totalBet = 0, betData = {}, lastRoundBets = {}, isAutoPlaying = false;
let isMuted = false, currentBgmIdx = 1, timeLeft = 20; 
const bgmList = [null, 'bgm1', 'bgm2', 'bgm3'];
const BET_LIMIT = 6000;
const DICE_CHARS = ["", "âš€", "âš", "âš‚", "âšƒ", "âš„", "âš…"];
const SUM_ODDS = { 4:69, 17:69, 5:34, 16:34, 6:20, 15:20, 7:13, 14:13, 8:9, 13:9, 9:7.4, 10:6.8, 11:6.8, 12:7.4 };

// --- è²éŸ³é‚è¼¯ ---
function playSound(id) { if (!isMuted) { const s = document.getElementById(id); if(s) { s.volume = 1.0; s.currentTime = 0; s.play().catch(()=>{}); } } }
function toggleMute() { isMuted = !isMuted; document.getElementById('soundIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; }
function cycleBGM() {
    bgmList.forEach(id => { if(id){ const a=document.getElementById(id); a.pause(); a.muted=true; a.currentTime=0; } });
    currentBgmIdx = (currentBgmIdx + 1) % 4;
    const btn = document.getElementById('bgmBtn');
    if (currentBgmIdx === 0) btn.textContent = 'ğŸš« éŸ³æ¨‚é—œ';
    else {
        const bgm = document.getElementById(bgmList[currentBgmIdx]);
        if(bgm) { bgm.muted = false; bgm.volume = 0.3; bgm.play().catch(()=>{}); btn.textContent = 'ğŸµ éŸ³æ¨‚ ' + currentBgmIdx; }
    }
}

// --- æ•¸æ“šå­˜å– ---
async function saveData() { 
    localStorage.setItem('sicbo_balance', balance); 
    localStorage.setItem('sicbo_history', JSON.stringify(historyData.slice(0,500))); 
    localStorage.setItem('sicbo_triple_miss', missCount); 
    
    const playerId = localStorage.getItem('player_id');
    if (playerId && db) {
        try {
            await db.collection("users").doc(playerId).update({ 
                balance: balance,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) { console.warn("é›²ç«¯åŒæ­¥æš«ç·©ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æ³¢å‹•ï¼‰"); }
    }
}

function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='fullHistoryOverlay') renderFullHistory(); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// --- åˆå§‹åŒ– ---
function initTable() {
  const sRow = document.getElementById('sumRow'), gRow = document.getElementById('singleRow');
  sRow.innerHTML = ''; gRow.innerHTML = '';
  for(let i=4; i<=17; i++) sRow.innerHTML += `<div class="bet-cell" onclick="placeBet('sum_${i}')">${i}<div class="odds-label">1:${SUM_ODDS[i]}</div><div id="chip-sum_${i}"></div></div>`;
  for(let i=1; i<=6; i++) gRow.innerHTML += `<div class="bet-cell" onclick="placeBet('single_${i}')">${i}<div class="odds-label">1:1</div><div id="chip-single_${i}"></div></div>`;
  updateUI(); renderHistory(); loadTripleWinners();
}

// --- ç›£è½åœéª°æ¦œ (æ”¹ç‚ºè®€å–æœ€è¿‘ 1 ç­†é¡¯ç¤ºåœ¨å´é‚Š) ---
function loadTripleWinners() {
    db.collection("sicbo_wins").orderBy("time", "desc").limit(1).onSnapshot(snapshot => {
        const info = document.getElementById('latestWinnerInfo');
        if (!snapshot.empty) {
            const latest = snapshot.docs[0].data();
            info.innerHTML = `${latest.name} <br> è´ $${Math.floor(latest.win).toLocaleString()}`;
        } else {
            info.innerText = "ç­‰å¾…...";
        }
    });
}

// --- é¡¯ç¤ºæœ€è¿‘ 10 æ¬¡åœéª°ç²çæ’è¡Œæ¦œ ---
async function showRank() {
    const modal = document.getElementById('tripleRankOverlay');
    const list = document.getElementById('tripleRankList');
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">è¼‰å…¥ä¸­...</div>';
    modal.style.display = 'flex';

    try {
        const snapshot = await db.collection("sicbo_wins").orderBy("time", "desc").limit(10).get();
        list.innerHTML = '';
        if (snapshot.empty) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æš«ç„¡ç´€éŒ„</div>';
            return;
        }
        snapshot.forEach(doc => {
            const data = doc.data();
            const row = document.createElement('div');
            row.className = 'rank-item';
            row.innerHTML = `
                <span class="rank-name">${data.name} (${data.dice})</span>
                <span class="rank-amt">+$${Math.floor(data.win).toLocaleString()}</span>
            `;
            list.appendChild(row);
        });
    } catch (error) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#ff4757;">è®€å–å¤±æ•—</div>';
    }
}

// --- éŠæˆ²é‚è¼¯ ---
function selectChip(val, el) { currentChip = val; document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); playSound('sndTick'); }
function placeBet(key) {
  // 1. æ™‚é–“é™åˆ¶åˆ¤æ–·
  if (timeLeft <= 3) return;

  // 2. é¤˜é¡åˆ¤æ–·
  if (balance < currentChip) {
    alert("é¤˜é¡ä¸è¶³ï¼");
    return;
  }

  // 3. ã€æ–°å¢ã€‘å–®é …ä¸‹æ³¨ä¸Šé™åˆ¤æ–· (BET_LIMIT)
  let currentPosBet = (betData[key] || 0);
  if (currentPosBet + currentChip > BET_LIMIT) {
    return;
  }

  // 4. ã€æ–°å¢ã€‘ç¸½ä¸‹æ³¨é¡é™åˆ¶ (å¯é¸ï¼Œè‹¥æ‚¨éœ€è¦é™åˆ¶æ•´å ´ç¸½é¡ï¼Œå¯åŠ æ­¤æ®µ)
  // if (totalBet + currentChip > 20000) { 
  //   alert("ç¸½ä¸‹æ³¨é¡å·²é”ä¸Šé™"); 
  //   return; 
  // }

  // åŸ·è¡Œä¸‹æ³¨
  betData[key] = currentPosBet + currentChip; 
  balance -= currentChip; 
  totalBet += currentChip;
  
  playSound('sndChip'); 
  updateUI(); 
  renderChip(key);
}

// ... å…¶é¤˜å‡½å¼ä¿æŒä¸è®Š ...

// ä¿®æ”¹ repeatBets ä¹Ÿè¦è€ƒæ…®é™åˆ¶ (é¿å…è‡ªå‹•æŠ•æ³¨æ™‚çˆ†é¡åº¦)
function repeatBets() {
  for (let k in lastRoundBets) {
    let amtToBet = lastRoundBets[k];
    let currentInPos = (betData[k] || 0);
    
    // è¨ˆç®—è©²ä½ç½®é‚„èƒ½å¡å¤šå°‘ç±Œç¢¼
    let canBetAmt = Math.min(amtToBet, BET_LIMIT - currentInPos);
    let clicks = Math.floor(canBetAmt / currentChip);
    
    for(let i=0; i<clicks; i++) {
      if (balance >= currentChip) {
        placeBet(k);
      }
    }
  }
}
function renderChip(key) {
  const container = document.getElementById('chip-' + key);
  let chip = container.querySelector('.chip-on-cell') || document.createElement('div');
  chip.className = 'chip-on-cell'; chip.textContent = betData[key];
  container.appendChild(chip);
}
function updateUI() {
  document.getElementById('balanceText').textContent = Math.floor(balance).toLocaleString();
  document.getElementById('totalBetText').textContent = totalBet.toLocaleString();
  document.getElementById('missCountText').textContent = missCount;
}

function simulateRound() {
  playSound('sndDice');
  let d = [Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1, Math.floor(Math.random()*6)+1];
  const sum = d[0]+d[1]+d[2], isTriple = (d[0]===d[1] && d[1]===d[2]);
  
  missCount = isTriple ? 0 : missCount + 1;

  const center = document.getElementById('centerDisplay');
  document.getElementById('bigDiceIcons').textContent = `${DICE_CHARS[d[0]]} ${DICE_CHARS[d[1]]} ${DICE_CHARS[d[2]]}`;
  document.getElementById('bigResultText').textContent = `${sum} é» - ${isTriple ? "åœéª°" : (sum >= 11 ? "å¤§" : "å°")}`;
  center.style.display = 'block'; 
  setTimeout(() => center.classList.add('show'), 50);
  if (isTriple) playSound('sndTriple');

  let winTotal = 0, tripleWinAmt = 0;
  for (let key in betData) {
    let amt = betData[key], won = 0;
    if (!isTriple) { 
        if (key === 'small' && sum <= 10) won = amt * 1; 
        if (key === 'big' && sum >= 11) won = amt * 1; 
    }
    if (key === `sum_${sum}`) won = amt * SUM_ODDS[sum];
    if (key === 'anyTriple' && isTriple) { won = amt * 34; tripleWinAmt += (amt + won); }
    if (key === `triple_${d[0]}` && isTriple) { won = amt * 210; tripleWinAmt += (amt + won); }
    if (key === `single_${d[0]}`) won += amt * 1;
    if (key === `single_${d[1]}`) won += amt * 1;
    if (key === `single_${d[2]}`) won += amt * 1;
    if (won > 0) winTotal += (amt + won);
  }

  // åƒ…åœ¨é–‹å‡ºåœéª°ä¸”æœ‰äººç²çæ™‚å­˜å…¥ç´€éŒ„
  if (isTriple && tripleWinAmt > 0) {
      db.collection("sicbo_wins").add({
          name: localStorage.getItem('player_name') || 'å¹¸é‹å…’',
          win: tripleWinAmt, dice: `${d[0]}${d[1]}${d[2]}`, time: firebase.firestore.FieldValue.serverTimestamp()
      });
  }

  balance += winTotal;
  if (winTotal > 0) {
      setTimeout(() => { if(!isTriple) playSound('sndWin'); }, 1200);
      const effect = document.getElementById('winAmountEffect');
      effect.textContent = `+${winTotal.toLocaleString()}`;
      isTriple ? effect.classList.add('triple-win-scale') : effect.classList.remove('triple-win-scale');
      setTimeout(() => { effect.style.display = 'block'; setTimeout(() => effect.style.display = 'none', 2000); }, 1200);
  }
  
  historyData.unshift({ dice: d.join(' '), sum, type: isTriple ? 'triple' : (sum >= 11 ? 'big' : 'small') });
  
  setTimeout(() => {
    center.classList.remove('show'); setTimeout(() => center.style.display = 'none', 300);
    lastRoundBets = JSON.parse(JSON.stringify(betData)); betData = {}; totalBet = 0;
    document.querySelectorAll('.chip-on-cell').forEach(c => c.remove());
    updateUI(); renderHistory(); saveData();
    if (isAutoPlaying) setTimeout(repeatBets, 600);
  }, 4500);
}

function clearBets() { balance += totalBet; totalBet = 0; betData = {}; document.querySelectorAll('.chip-on-cell').forEach(c => c.remove()); updateUI(); }
function toggleAuto() { isAutoPlaying = !isAutoPlaying; document.getElementById('btnAuto').classList.toggle('btn-auto-active', isAutoPlaying); if (isAutoPlaying && timeLeft > 3) repeatBets(); }
function renderHistory() { document.getElementById('historyList').innerHTML = historyData.slice(0, 10).map(h => `<div class="hist-item"><span>${h.dice}</span><span class="sum-${h.type}">${h.sum}</span></div>`).join(''); }
function renderFullHistory() { document.getElementById('fullHistoryList').innerHTML = historyData.slice(0, 300).map(h => `<div class="rank-item"><span>${h.dice}</span><span class="sum-${h.type}">${h.sum}</span></div>`).join(''); }

setInterval(() => { 
  timeLeft--; 
  if (timeLeft < 0) { timeLeft = 20; simulateRound(); } 
  else if (timeLeft <= 5 && timeLeft > 0) playSound('sndTick');
  document.getElementById('timer').textContent = timeLeft; 
}, 1000);

window.onload = async () => {
    const playerId = localStorage.getItem('player_id');
    const localBal = localStorage.getItem('sicbo_balance');
    if (localBal !== null) { balance = parseFloat(localBal); }

    if (playerId && db) {
        try {
            const doc = await db.collection("users").doc(playerId).get();
            if (doc.exists) {
                const cloudBal = doc.data().balance;
                if (cloudBal !== undefined && cloudBal > balance) {
                    balance = cloudBal;
                    localStorage.setItem('sicbo_balance', balance);
                } 
                else if (cloudBal !== undefined && balance > cloudBal) {
                    saveData(); 
                }
            }
        } catch (e) { console.log("é›¢ç·šæ¨¡å¼"); }
    }
    initTable();
    updateUI();

    document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', async (e) => {
            const href = link.getAttribute('href');
            if (href && href !== '#' && !href.startsWith('javascript')) {
                e.preventDefault();
                await saveData();
                window.location.href = href;
            }
        });
    });
};

window.addEventListener('pagehide', () => {
    localStorage.setItem('sicbo_balance', balance);
});
</script>
</body>
</html>